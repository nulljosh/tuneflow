#!/bin/bash
# OpenClaw Health Monitor & Auto-Recovery
# Detects and fixes common OpenClaw issues automatically

set -e

LOG_FILE="$HOME/.openclaw/logs/health-monitor.log"
GATEWAY_LOG="$HOME/Library/Logs/openclaw/gateway.log"
ERROR_LOG="$HOME/Library/Logs/openclaw/gateway.err.log"
STATE_FILE="$HOME/.openclaw/health-state.json"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" | tee -a "$LOG_FILE"
}

success() {
    echo -e "${GREEN}[OK]${NC} $1" | tee -a "$LOG_FILE"
}

# Initialize state file
init_state() {
    if [ ! -f "$STATE_FILE" ]; then
        echo '{"last_recovery": 0, "recovery_count": 0, "last_context_clear": 0}' > "$STATE_FILE"
    fi
}

get_state() {
    local key=$1
    cat "$STATE_FILE" | jq -r ".$key // 0"
}

update_state() {
    local key=$1
    local value=$2
    local tmp=$(mktemp)
    jq ".$key = $value" "$STATE_FILE" > "$tmp" && mv "$tmp" "$STATE_FILE"
}

# Check 1: Gateway running
check_gateway() {
    log "Checking gateway status..."
    if pgrep -f "openclaw.*gateway" > /dev/null; then
        success "Gateway is running"
        return 0
    else
        error "Gateway is not running"
        return 1
    fi
}

# Check 2: Full Disk Access permissions
check_permissions() {
    log "Checking Full Disk Access permissions..."

    # Check if imsg has permission
    if ls "$HOME/Library/Messages/chat.db" &> /dev/null; then
        success "Full Disk Access OK"
        return 0
    else
        error "Full Disk Access permission missing for /opt/homebrew/bin/imsg"
        warn "Fix: System Settings → Privacy & Security → Full Disk Access → Add /opt/homebrew/bin/imsg"
        return 1
    fi
}

# Check 3: Recent errors in logs
check_logs() {
    log "Checking for recent errors..."

    if [ ! -f "$ERROR_LOG" ]; then
        success "No error log found (good)"
        return 0
    fi

    # Check last 50 lines for critical errors
    recent_errors=$(tail -50 "$ERROR_LOG" 2>/dev/null | grep -i "error\|fatal\|crash" | wc -l || echo 0)

    if [ "$recent_errors" -gt 10 ]; then
        error "Found $recent_errors recent errors in logs"
        return 1
    else
        success "Error count acceptable ($recent_errors errors in last 50 lines)"
        return 0
    fi
}

# Check 4: Context size (detect unresponsive agent)
check_context_size() {
    log "Checking context usage..."

    # Look for context-related warnings in recent logs
    if [ -f "$GATEWAY_LOG" ]; then
        context_warnings=$(tail -200 "$GATEWAY_LOG" 2>/dev/null | grep -i "context\|window\|token.*limit" | wc -l || echo 0)

        if [ "$context_warnings" -gt 5 ]; then
            warn "Context may be overloaded ($context_warnings warnings found)"
            return 1
        else
            success "Context size healthy"
            return 0
        fi
    fi
    return 0
}

# Check 5: API connectivity
check_api() {
    log "Checking API connectivity..."

    # Check for recent API errors
    if [ -f "$GATEWAY_LOG" ]; then
        api_errors=$(tail -100 "$GATEWAY_LOG" 2>/dev/null | grep -i "api.*error\|billing.*error\|rate.*limit" | wc -l || echo 0)

        if [ "$api_errors" -gt 3 ]; then
            error "Multiple API errors detected ($api_errors errors)"
            return 1
        else
            success "API connectivity OK"
            return 0
        fi
    fi
    return 0
}

# Recovery action: Restart gateway
recover_gateway() {
    log "Attempting gateway restart..."
    openclaw gateway restart
    sleep 3

    if check_gateway; then
        success "Gateway restart successful"
        return 0
    else
        error "Gateway restart failed"
        return 1
    fi
}

# Recovery action: Clear context
recover_context() {
    log "Context recovery needed..."

    # Check if we've cleared recently (within last hour)
    last_clear=$(get_state "last_context_clear")
    current_time=$(date +%s)
    time_since_clear=$((current_time - last_clear))

    if [ $time_since_clear -lt 3600 ]; then
        warn "Context was cleared recently (${time_since_clear}s ago), skipping"
        return 0
    fi

    warn "Context may be overloaded. Consider using /new command in next interaction"
    update_state "last_context_clear" "$current_time"
    return 0
}

# Recovery action: Rebuild memory index
recover_memory() {
    log "Rebuilding memory index..."
    openclaw memory index
    success "Memory index rebuilt"
    return 0
}

# Main health check routine
run_health_check() {
    log "=== OpenClaw Health Check Started ==="

    init_state

    issues=0

    # Run all checks
    check_gateway || issues=$((issues + 1))
    check_permissions || issues=$((issues + 1))
    check_logs || issues=$((issues + 1))
    check_context_size || issues=$((issues + 1))
    check_api || issues=$((issues + 1))

    # Attempt recovery if needed
    if [ $issues -gt 0 ]; then
        warn "Found $issues issue(s), attempting recovery..."

        # Check recovery throttle (max 1 recovery per 10 minutes)
        last_recovery=$(get_state "last_recovery")
        current_time=$(date +%s)
        time_since_recovery=$((current_time - last_recovery))

        if [ $time_since_recovery -lt 600 ]; then
            error "Recovery attempted too recently (${time_since_recovery}s ago), skipping"
            exit 1
        fi

        # Gateway down - restart it
        if ! check_gateway; then
            recover_gateway
        fi

        # Context issues - suggest clearing
        if ! check_context_size; then
            recover_context
        fi

        # Memory issues - rebuild index
        if ! check_api; then
            recover_memory
        fi

        # Update recovery state
        update_state "last_recovery" "$current_time"
        recovery_count=$(get_state "recovery_count")
        update_state "recovery_count" $((recovery_count + 1))

        log "Recovery complete. Total recoveries: $((recovery_count + 1))"
    else
        success "All checks passed, OpenClaw is healthy"
    fi

    log "=== Health Check Complete ==="
}

# Auto-recovery mode (called by launchd)
auto_recover() {
    # Silent mode for automated runs
    exec > "$LOG_FILE" 2>&1
    run_health_check
}

# Usage
case "${1:-check}" in
    check)
        run_health_check
        ;;
    auto)
        auto_recover
        ;;
    *)
        echo "Usage: $0 {check|auto}"
        echo "  check - Run interactive health check"
        echo "  auto  - Run silent auto-recovery (for automation)"
        exit 1
        ;;
esac
