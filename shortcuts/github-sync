#!/bin/bash
# github-sync: Keep GitHub repos synced with ~/Documents/Code

CODE_DIR="$HOME/Documents/Code"
GITHUB_USER="nulljosh"
LOG_FILE="/tmp/github-sync.log"

echo "=== GitHub Sync $(date) ===" | tee -a "$LOG_FILE"

# Get local repos (dirs with .git)
LOCAL_REPOS=$(cd "$CODE_DIR" && find . -maxdepth 2 -type d -name ".git" | sed 's/\.\///g; s/\/\.git//g' | sort)

# Get GitHub repos
GITHUB_REPOS=$(gh repo list "$GITHUB_USER" --limit 200 --json name --jq '.[].name' | sort)

# Check each local repo
echo "$LOCAL_REPOS" | while read -r repo; do
  [ -z "$repo" ] && continue
  
  cd "$CODE_DIR/$repo" || continue
  
  # Skip if remote is not nulljosh (forks, other orgs)
  REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
  if [[ "$REMOTE" != *"github.com/$GITHUB_USER"* ]] && [[ "$REMOTE" != "" ]]; then
    echo "â­ï¸  Skipping $repo (remote: $REMOTE)" | tee -a "$LOG_FILE"
    continue
  fi
  
  # Check if exists on GitHub
  if ! echo "$GITHUB_REPOS" | grep -q "^${repo}$"; then
    echo "ðŸ“¤ Creating GitHub repo: $repo" | tee -a "$LOG_FILE"
    gh repo create "$GITHUB_USER/$repo" --public --source=. --remote=origin --push 2>&1 | tee -a "$LOG_FILE"
  else
    # Repo exists, push any changes
    if git diff --quiet && git diff --cached --quiet; then
      echo "âœ“ $repo (no changes)" | tee -a "$LOG_FILE"
    else
      echo "ðŸ“¤ Pushing changes: $repo" | tee -a "$LOG_FILE"
      git add -A
      git commit -m "Auto-sync $(date +%Y-%m-%d)" 2>&1 | tee -a "$LOG_FILE"
      git push origin main 2>&1 | tee -a "$LOG_FILE"
    fi
  fi
done

echo "=== Sync complete ===" | tee -a "$LOG_FILE"
