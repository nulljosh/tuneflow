#!/usr/bin/env node

/**
 * Cron Job Dashboard - Web Server
 * Serves an auto-refreshing HTML dashboard on localhost
 * Access at: http://localhost:8765
 */

const http = require('http');
const fs = require('fs');
const path = require('path');
const os = require('os');

const PORT = process.env.CRON_PORT || 8765;
const CRON_CONFIG = path.join(os.homedir(), '.openclaw/cron/jobs.json');

/**
 * Parse cron expression
 */
function parseCronExpr(expr, tz) {
  const parts = expr.split(' ');
  if (parts.length < 5) return expr;

  const [min, hour, day, month, dow] = parts;
  const descriptions = [];
  
  if (min !== '*' && hour !== '*') {
    descriptions.push(`${hour.padStart(2, '0')}:${min.padStart(2, '0')}`);
  } else if (hour !== '*') {
    descriptions.push(`Every hour at minute ${min}`);
  }

  return descriptions.length > 0 ? descriptions.join(' ') : expr;
}

/**
 * Format time
 */
function formatTime(ms) {
  if (!ms) return 'Never';
  return new Date(ms).toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
}

/**
 * Time until
 */
function timeUntil(nextRunMs) {
  if (!nextRunMs) return '‚Äî';
  const diff = nextRunMs - Date.now();
  if (diff < 0) return 'Past due';
  
  const hours = Math.floor(diff / 3600000);
  const mins = Math.floor((diff % 3600000) / 60000);
  
  if (hours > 24) {
    const days = Math.floor(hours / 24);
    return `${days}d ${hours % 24}h`;
  } else if (hours > 0) {
    return `${hours}h ${mins}m`;
  } else {
    return `${mins}m`;
  }
}

/**
 * Get schedule description
 */
function getScheduleDesc(job) {
  const sched = job.schedule;
  
  switch (sched.kind) {
    case 'cron':
      return `Every: ${parseCronExpr(sched.expr, sched.tz)} (${sched.tz || 'UTC'})`;
    case 'at':
      return `Once at: ${new Date(sched.at).toLocaleString()}`;
    case 'every':
      const mins = Math.floor(sched.everyMs / 60000);
      const hours = Math.floor(mins / 60);
      return `Every ${hours > 0 ? `${hours}h ${mins % 60}m` : `${mins}m`}`;
    default:
      return sched.kind;
  }
}

/**
 * Load jobs
 */
function loadJobs() {
  try {
    const content = fs.readFileSync(CRON_CONFIG, 'utf8');
    return JSON.parse(content).jobs || [];
  } catch (err) {
    return [];
  }
}

/**
 * Generate dashboard HTML
 */
function generateDashboard(jobs) {
  const enabled = jobs.filter(j => j.enabled).length;
  const successful = jobs.filter(j => j.state?.lastStatus === 'ok').length;
  const failed = jobs.filter(j => j.state?.lastStatus === 'error').length;
  
  const jobRows = jobs.map(job => `
    <tr class="job-row ${job.enabled ? 'enabled' : 'disabled'}">
      <td class="status-col">${job.enabled ? '‚úÖ' : '‚è∏Ô∏è'}</td>
      <td class="name-col">${job.name}</td>
      <td class="schedule-col">${getScheduleDesc(job)}</td>
      <td class="next-col">
        ${job.state?.nextRunAtMs ? `
          <span class="next-time">${formatTime(job.state.nextRunAtMs)}</span>
          <span class="countdown">${timeUntil(job.state.nextRunAtMs)}</span>
        ` : '<span class="never">Not scheduled</span>'}
      </td>
      <td class="last-col">
        ${job.state?.lastRunAtMs ? `
          <span class="last-time">${formatTime(job.state.lastRunAtMs)}</span>
          <span class="status-badge ${job.state.lastStatus === 'ok' ? 'ok' : 'error'}">${job.state.lastStatus || '?'}</span>
        ` : '<span class="never">Never</span>'}
      </td>
    </tr>
  `).join('');
  
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="5">
  <title>Cron Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      color: #e6edf3;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #30363d;
    }
    
    h1 {
      font-size: 32px;
      color: #58a6ff;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .refresh-info {
      color: #8b949e;
      font-size: 12px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat {
      background: rgba(22, 27, 34, 0.8);
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #58a6ff;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-wrapper {
      background: rgba(13, 17, 23, 0.9);
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    thead {
      background: rgba(48, 54, 61, 0.5);
      border-bottom: 2px solid #30363d;
    }
    
    th {
      padding: 12px 15px;
      text-align: left;
      color: #79c0ff;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #21262d;
    }
    
    tr:hover {
      background: rgba(48, 54, 61, 0.3);
    }
    
    tr.disabled {
      opacity: 0.6;
    }
    
    .status-col {
      width: 40px;
      text-align: center;
      font-size: 16px;
    }
    
    .name-col {
      font-weight: 500;
      color: #79c0ff;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .schedule-col {
      color: #8b949e;
      font-family: 'Monaco', 'Courier', monospace;
      font-size: 12px;
    }
    
    .next-col, .last-col {
      font-size: 12px;
    }
    
    .next-time, .last-time {
      display: block;
      color: #79c0ff;
      font-weight: 500;
    }
    
    .countdown {
      display: block;
      color: #8b949e;
      font-size: 11px;
      margin-top: 2px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 4px;
    }
    
    .status-badge.ok {
      background: rgba(63, 185, 80, 0.2);
      color: #3fb950;
    }
    
    .status-badge.error {
      background: rgba(248, 81, 73, 0.2);
      color: #f85149;
    }
    
    .never {
      color: #8b949e;
      font-style: italic;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #8b949e;
      font-size: 11px;
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚è∞ Cron Dashboard</h1>
      <div class="refresh-info">
        <div>Auto-refreshing every 5 seconds</div>
        <div>Updated: <span class="pulse">${new Date().toLocaleTimeString()}</span></div>
      </div>
    </div>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-value">${jobs.length}</div>
        <div class="stat-label">Total Jobs</div>
      </div>
      <div class="stat">
        <div class="stat-value">${enabled}</div>
        <div class="stat-label">Enabled</div>
      </div>
      <div class="stat">
        <div class="stat-value">${successful}</div>
        <div class="stat-label">Last OK</div>
      </div>
      <div class="stat">
        <div class="stat-value">${failed}</div>
        <div class="stat-label">Last Failed</div>
      </div>
    </div>
    
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Job Name</th>
            <th>Schedule</th>
            <th>Next Run</th>
            <th>Last Run</th>
          </tr>
        </thead>
        <tbody>
          ${jobRows}
        </tbody>
      </table>
    </div>
    
    <div class="footer">
      <p>Cron Job Dashboard ‚Ä¢ OpenClaw Gateway ‚Ä¢ <a href="/api/jobs" style="color: #58a6ff; text-decoration: none;">API</a></p>
    </div>
  </div>
</body>
</html>`;
}

/**
 * HTTP Server
 */
const server = http.createServer((req, res) => {
  const jobs = loadJobs();
  
  if (req.url === '/') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(generateDashboard(jobs));
  } else if (req.url === '/api/jobs') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(jobs, null, 2));
  } else if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ status: 'ok', jobs: jobs.length }));
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('Not Found');
  }
});

server.listen(PORT, 'localhost', () => {
  console.log(`
üåê Cron Dashboard Web Server

  üìä Dashboard: http://localhost:${PORT}
  üì° API:       http://localhost:${PORT}/api/jobs
  üíö Health:    http://localhost:${PORT}/health

  Auto-refreshes every 5 seconds
  Press Ctrl+C to stop

`);
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n‚úÖ Dashboard closed');
  server.close();
});
