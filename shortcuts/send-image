#!/bin/bash
# send-image: Download image ‚Üí send via iMessage (FIXED: proper headers, working sources)

# Auto-convert HEIC to JPG if input is local HEIC file
if [ -f "$1" ] && [[ "$1" == *.heic ]] || [[ "$1" == *.HEIC ]]; then
  HEIC_FILE="$1"
  JPG_CONVERTED="/tmp/converted_$(date +%s).jpg"
  echo "üîÑ Converting HEIC to JPG..."
  sips -s format jpeg "$HEIC_FILE" --out "$JPG_CONVERTED" 2>/dev/null
  if [ -f "$JPG_CONVERTED" ] && [ -s "$JPG_CONVERTED" ]; then
    shift
    set -- "$JPG_CONVERTED" "$@"
    echo "‚úì HEIC converted to JPG"
  else
    echo "‚ùå HEIC conversion failed"
    exit 1
  fi
fi

URL="$1"
RECIPIENT="${2:-+17788462726}"
TEXT="${3:-Image}"

[ -z "$URL" ] && echo "Usage: send-image <url|random> [recipient] [text]" && exit 1

# If URL is "random", pick from working sources
if [ "$URL" = "random" ]; then
  SOURCES=(
    "https://picsum.photos/800/600"
    "https://source.unsplash.com/random/800x600"
    "https://loremflickr.com/800/600"
  )
  URL="${SOURCES[$RANDOM % ${#SOURCES[@]}]}"
  echo "üé≤ Random image: $URL"
fi

# Detect video URLs
if echo "$URL" | grep -qiE '\.(mp4|mov|webm|avi|mkv)(\?|$)' || \
   echo "$URL" | grep -qiE '(youtube\.com|youtu\.be|vimeo\.com|tiktok\.com|twitter\.com/.*/(video|status)|x\.com/.*/(video|status))'; then
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  echo "üé¨ Video detected, delegating to send-video..."
  exec "$SCRIPT_DIR/send-video" "$URL" "$RECIPIENT" "$TEXT"
fi

# Setup temp files
TIMESTAMP=$(date +%s%N)
TEMP_FILE="/tmp/send_img_${TIMESTAMP}.tmp"
JPG_FILE="/tmp/send_img_${TIMESTAMP}.jpg"
CURL_LOG="/tmp/send_img_${TIMESTAMP}.curl.log"

trap "rm -f '$TEMP_FILE' '$JPG_FILE' '$CURL_LOG'" EXIT

# Download with proper headers
echo "‚¨áÔ∏è  Downloading: $URL"

if curl -L -s \
  -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36" \
  -H "Accept: image/*,*/*;q=0.8" \
  -H "Referer: https://www.google.com/" \
  --max-time 15 \
  --connect-timeout 5 \
  --max-redirs 5 \
  --retry 2 \
  "$URL" -o "$TEMP_FILE" 2>"$CURL_LOG"; then
  
  # Verify download
  if [ ! -f "$TEMP_FILE" ] || [ ! -s "$TEMP_FILE" ]; then
    echo "‚ùå Download failed: empty file"
    cat "$CURL_LOG"
    exit 1
  fi
  
  SIZE=$(stat -f%z "$TEMP_FILE" 2>/dev/null || stat -c%s "$TEMP_FILE" 2>/dev/null)
  echo "‚úì Downloaded: $SIZE bytes"
  
  # Check if it's actually an image
  FILE_TYPE=$(file -b "$TEMP_FILE" 2>/dev/null)
  MAGIC=$(xxd -p -l 4 "$TEMP_FILE" 2>/dev/null | tr -d '\n')
  
  # Valid image magic bytes
  if [[ "$MAGIC" == "ffd8ff"* ]] || \
     [[ "$MAGIC" == "89504e47"* ]] || \
     [[ "$MAGIC" == "47494638"* ]] || \
     [[ "$MAGIC" == "424d"* ]] || \
     echo "$FILE_TYPE" | grep -qiE '(image|jpeg|png|gif|bmp|webp)'; then
    echo "‚úì Valid image detected: $FILE_TYPE"
  else
    echo "‚ùå Not an image file (got: $FILE_TYPE, magic: $MAGIC)"
    echo "First 100 bytes:"
    head -c 100 "$TEMP_FILE"
    exit 1
  fi
else
  echo "‚ùå curl failed"
  cat "$CURL_LOG"
  exit 1
fi

# Convert to JPG (always)
echo "üì¶ Converting to JPG..."

if sips -s format jpeg "$TEMP_FILE" --out "$JPG_FILE" 2>"$CURL_LOG"; then
  if [ -f "$JPG_FILE" ] && [ -s "$JPG_FILE" ]; then
    JPG_SIZE=$(stat -f%z "$JPG_FILE" 2>/dev/null || stat -c%s "$JPG_FILE" 2>/dev/null)
    echo "‚úì Converted to JPG: $JPG_SIZE bytes"
  else
    echo "‚ùå JPG conversion created empty file"
    cat "$CURL_LOG"
    exit 1
  fi
else
  echo "‚ùå sips conversion failed"
  cat "$CURL_LOG"
  exit 1
fi

# Send via iMessage
echo "üì§ Sending to $RECIPIENT..."

if imsg send --to "$RECIPIENT" --text "$TEXT" --file "$JPG_FILE" --service imessage 2>"$CURL_LOG"; then
  echo "‚úÖ Sent successfully!"
else
  echo "‚ùå imsg send failed"
  cat "$CURL_LOG"
  exit 1
fi
