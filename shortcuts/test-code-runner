#!/bin/bash
# Test Code Runner - Comprehensive test suite

RUNNER="$HOME/.openclaw/workspace/shortcuts/code-runner"
TESTS_PASSED=0
TESTS_FAILED=0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

test_case() {
    local name=$1
    local type=$2
    local code=$3
    local expected_substr=$4
    
    echo -e "${BLUE}Test: $name${NC}"
    
    result=$(echo "$code" | "$RUNNER" --type "$type" 2>&1)
    exit_code=$?
    
    if [[ $result == *"$expected_substr"* ]]; then
        echo -e "${GREEN}âœ“ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âœ— FAIL${NC}"
        echo "  Expected substring: $expected_substr"
        echo "  Got: $result"
        ((TESTS_FAILED++))
    fi
    echo ""
}

test_error() {
    local name=$1
    local type=$2
    local code=$3
    
    echo -e "${BLUE}Test: $name (should error)${NC}"
    
    result=$(echo "$code" | "$RUNNER" --type "$type" 2>&1)
    exit_code=$?
    
    if [ $exit_code -ne 0 ]; then
        echo -e "${GREEN}âœ“ PASS (correctly failed)${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âœ— FAIL (should have failed)${NC}"
        echo "  Got: $result"
        ((TESTS_FAILED++))
    fi
    echo ""
}

echo -e "${YELLOW}=== Code Runner Test Suite ===${NC}"
echo ""

# Python Tests
echo -e "${YELLOW}--- Python Tests ---${NC}"
test_case "Simple print" "python" "print('hello world')" "hello world"
test_case "Math operation" "python" "print(2 + 2)" "4"
test_case "List comprehension" "python" "print([x*2 for x in range(3)])" "[0, 2, 4]"
test_error "Syntax error" "python" "print('unclosed"

# Node.js Tests
echo -e "${YELLOW}--- Node.js Tests ---${NC}"
test_case "Simple log" "node" "console.log('hello from node')" "hello from node"
test_case "Math" "node" "console.log(3 * 4)" "12"
test_case "Array" "node" "console.log([1,2,3].map(x => x*2).join(','))" "2,4,6"
test_error "Syntax error" "node" "console.log(unclosed"

# SQL Tests
echo -e "${YELLOW}--- SQL Tests ---${NC}"
test_case "Simple select" "sql" "SELECT 1+1 as result;" "2"
test_case "Create and query" "sql" "CREATE TABLE t(x INT); INSERT INTO t VALUES(42); SELECT * FROM t;" "42"

# Bash Tests
echo -e "${YELLOW}--- Bash Tests ---${NC}"
test_case "Echo" "bash" "echo 'Hello Bash'" "Hello Bash"
test_case "Math" "bash" "echo $((5 * 6))" "30"
test_case "Pipe" "bash" "echo -e '3\n1\n2' | sort" "1"
test_error "Nonexistent command" "bash" "nonexistent_cmd_xyz"

# C Tests
echo -e "${YELLOW}--- C Tests ---${NC}"
test_case "Hello World C" "c" "#include <stdio.h>
int main() { printf(\"hello c\"); return 0; }" "hello c"

test_case "Loop in C" "c" "#include <stdio.h>
int main() { for(int i=1; i<=3; i++) printf(\"%d \", i*i); return 0; }" "1 4 9"

test_error "C syntax error" "c" "not valid c code {"

# Format Tests
echo -e "${YELLOW}--- Format Tests ---${NC}"
result=$(echo "print(42)" | "$RUNNER" --type python --format json)
if echo "$result" | grep -q "\"success\": true"; then
    echo -e "${BLUE}Test: JSON format${NC}"
    echo -e "${GREEN}âœ“ PASS${NC}"
    ((TESTS_PASSED++))
else
    echo -e "${BLUE}Test: JSON format${NC}"
    echo -e "${RED}âœ— FAIL${NC}"
    echo "  Got: $result"
    ((TESTS_FAILED++))
fi
echo ""

# Edge Cases
echo -e "${YELLOW}--- Edge Case Tests ---${NC}"
test_case "Empty line handling" "python" "
print('with newlines')
" "with newlines"

test_case "Large output handling" "python" "
for i in range(100):
    print('line ' + str(i))
" "line 99"  # Should show part of it

test_case "Unicode/special chars" "python" "print('Hello ä¸–ç•Œ ðŸŒ')" "ä¸–ç•Œ"

# Summary
echo -e "${YELLOW}=== Test Summary ===${NC}"
echo -e "Passed: ${GREEN}$TESTS_PASSED${NC}"
echo -e "Failed: ${RED}$TESTS_FAILED${NC}"
echo "Total: $((TESTS_PASSED + TESTS_FAILED))"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All tests passed!${NC}"
    exit 0
else
    echo -e "${RED}âœ— Some tests failed${NC}"
    exit 1
fi
